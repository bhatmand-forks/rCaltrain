!function(){"use strict";function e(e){return"undefined"!=typeof e&&null!==e}function t(){var e=";expires="+new Date(Date.now()+31536e6).toUTCString();document.cookie="from="+encodeURIComponent(w.getText())+e,document.cookie="to="+encodeURIComponent(k.getText())+e,document.cookie="when="+encodeURIComponent(C(".when-button.selected").value)+e}function n(e){var t=new RegExp("(?:(?:^|.*;\\s*)"+e+"\\s*\\=\\s*([^;]*).*$)|^.*$");return decodeURIComponent(document.cookie.replace(t,"$1"))}function r(){var t=n("from"),r=n("to"),a=n("when");if(e(t)&&w.setText(t),e(r)&&k.setText(r),e(a)){var o=C('.when-button[value="'+a+'"]');e(o)&&o.addClass("selected")}}function a(){var e=new Date;return 60*e.getHours()*60+60*e.getMinutes()+e.getSeconds()}function o(){var e=new Date;return parseInt([e.getFullYear(),e.getMonth()+1,e.getDate()].map(function(e){return e.toString().rjust(2,"0")}).join(""))}function i(e){var t=Math.floor(e/60);return[Math.floor(t/60)%24,t%60].map(function(e){return e.toString().rjust(2,"0")}).join(":")}function s(e,t){return Math.round((t-e)/60)}function c(){return"now"===C(".when-button.selected").value}function u(e,t){var n=o(),r=C(".when-button.selected").value,a=r;if("now"===a)switch(((new Date).getDay()+6)%7){case 5:a="saturday";break;case 6:a="sunday";break;case 0:case 1:case 2:case 3:case 4:a="weekday";break;default:return console.error("Unknown current day",((new Date).getDay()+6)%7),[]}var i=Object.keys(e).filter(function(t){var r=e[t];return r.start_date<=n&&n<=r.end_date}).filter(function(t){return e[t][a]});return"now"===r&&(i=i.filter(function(e){return!(e in t)||0===t[e].filter(function(e){return e[0]===n&&2===e[1]}).length}).concat(Object.keys(t).filter(function(e){return 0!==t[e].filter(function(e){return e[0]===n&&1===e[1]}).length}))),0===i.length&&console.log("Can't get service for now."),i}function d(t,n,r){var a={};return u(n,r).forEach(function(n){Object.keys(t).forEach(function(r){var o=t[r],i=o[n];e(i)&&(e(a[r])||(a[r]={}),Object.extend(a[r],i))})}),a}function l(e,t){return t.map(function(t){return e.indexOf(t)}).filter(function(e){return-1!=e})}function f(e,t){return e.departure_time-t.departure_time}function p(t,n,r){var o=[];return Object.keys(t).forEach(function(i){var s=t[i];Object.keys(s).forEach(function(t){var i=s[t],u=i.map(function(e){return e[0]}),d=l(u,n),f=l(u,r);if(e(d)&&e(f)&&0!==d.length&&0!==f.length){var p=Math.min.apply(this,d),h=Math.max.apply(this,f);p>=h||(!c()||i[p][1]>a())&&o.push({departure_time:i[p][1],arrival_time:i[h][1]})}})}),o.sort(f)}function h(t){var n=C("#info").empty();if(c()&&e(t)){var r=s(a(),t.departure_time),o=C.createElement("div",{className:"info",textContent:"Next train: "+r+"min"});n.appendChild(o)}}function m(e){var t=C("#result").empty();e.forEach(function(e){var n=C.createElement("span",{className:"departure",textContent:i(e.departure_time)}),r=C.createElement("span",{className:"duration",textContent:s(e.departure_time,e.arrival_time)+" min"}),a=C.createElement("span",{className:"arrival",textContent:i(e.arrival_time)}),o=C.createElement("div",{className:"trip"});o.appendChild(n),o.appendChild(r),o.appendChild(a),t.appendChild(o)})}function v(){var n=x.stops,r=x.routes,a=x.calendar,o=x.calendar_dates,i=n[w.getText()],s=n[k.getText()],c=d(r,a,o);if(e(i)&&e(s)&&e(c)){var u=p(c,i,s);t(),h(u[0]),m(u)}}function y(){[w,k].forEach(function(e){e.on("focus",function(){e.setText(""),e.input.Show()}),e.on("change",v),e.on("complete",v)}),E.forEach(function(e){e.on("click",function(){E.forEach(function(e){e.removeClass("selected")}),e.addClass("selected"),v()})}),C("#reverse").on("click",function(){var e=w.getText();w.setText(k.getText()),k.setText(e),v()})}function g(){FastClick.attach(document.body),w=rComplete(C("#from"),{placeholder:"Departure"}),k=rComplete(C("#to"),{placeholder:"Destination"}),E=C.queryAll(".when-button");var e=Object.keys(x.stops);w.setOptions(e),k.setOptions(e),r(),y(),v(),"?test=true"===window.location.search&&T()}function _(e,t){var n={};Object.keys(e).forEach(function(e){n[e]=void 0}),Object.keys(e).forEach(function(r){C.getJSON(e[r],function(e){n[r]=e;for(var a in n)if("undefined"==typeof n[a])return;t(n)})})}function T(){!function(e,t,n,r){console.debug("Fetching test data"),_({weekday_NB_TT:"test/weekday_NB_TT.json",weekday_SB_TT:"test/weekday_SB_TT.json",weekend_NB_TT:"test/weekend_NB_TT.json",weekend_SB_TT:"test/weekend_SB_TT.json"},function(a){function o(e,t){if(!e){var n=C.createElement("div",{className:"test_result_item"});t.split("\n").forEach(function(e){var t=C.createElement("div",{textContent:e});n.appendChild(t)}),d.appendChild(n)}return e}function i(e){var t=e.split(":");return t[0]=t[0]%24,t.map(function(e){return e.toString().rjust(2,"0")}).join(":")}function s(e){return"["+i(e[0])+"=>"+i(e[1])+"]"}function c(e){return"["+e[0]+"=>"+e[1]+"]"}function u(n,a){for(var u=n.length-1;u>=0;u--){var d=n[u].name,l=n[u].stop_times;if(o(t.getOptions().indexOf(d)>=0,"to_name is not in options:"+d)){t.setText(d);for(var f=u-1;f>=0;f--){var p=n[f].name,h=n[f].stop_times;if(o(e.getOptions().indexOf(p)>=0,"from_name is not in options:"+p)){e.setText(p);var m=[];if(o(h.length===l.length,"from_stops and to_stops have different length:"+p+"=>"+d))for(var v=h.length-1;v>=0;v--){var y=h[v],g=l[v];if(o(y.service_type===g.service_type,"from_stop and to_stop have different type: schedule:"+a+", "+p+"("+y.service_type+")=>"+d+"("+g.service_type+")["+y.time+"=>"+g.time+"]")){var _=y.service_type;if("SatOnly"===_&&"saturday"!==a)continue;y.time&&g.time&&m.unshift([y.time,g.time])}}m.sort(function(e,t){return e=e[0]+"=>"+e[1],t=t[0]+"=>"+t[1],t>e?-1:e>t?1:0});for(var T=[],w=r.children.length-1;w>=0;w--){var k=r.children[w];T.unshift([k.children[0].textContent,k.children[2].textContent])}if(o(m.length===T.length,"expects and actuals have different length:"+p+"=>"+d+"\nexpects:"+m.map(s).join(", ")+"\nactuals:"+T.map(c).join(", ")))for(var E=T.length-1;E>=0;E--){var x=i(m[E][0]),C=i(m[E][1]);o(T[E][0]===x&&T[E][1]===C,"time mismatch: schedule:"+a+", "+p+"=>"+d+", expected:("+x+" => "+C+"), actual:("+T[E][0]+" => "+T[E][1]+")")}}}}}}console.debug("Start testing");var d=C.createElement("div",{id:"test_result"});document.documentElement.appendChild(d),n[1].click(),u(a.weekday_NB_TT,"weekday"),u(a.weekday_SB_TT,"weekday"),n[2].click(),u(a.weekend_NB_TT,"saturday"),u(a.weekend_SB_TT,"saturday"),n[3].click(),u(a.weekend_NB_TT,"sunday"),u(a.weekend_SB_TT,"sunday");var l=C.createElement("div",{textContent:"Total failed:"+d.children.length});d.insertBefore(l,d.firstChild),console.debug("Finish testing")})}(w,k,E,C("#result"))}var w,k,E,x={},C=function(){return document.querySelector.apply(document,arguments)};C.queryAll=function(){return document.querySelectorAll.apply(document,arguments)},C.createElement=function(t,n){var r=document.createElement(t);return e(n)&&Object.keys(n).forEach(function(e){r[e]=n[e]}),r},C.ready=function(e){"loading"!=document.readyState?e():document.addEventListener?document.addEventListener("DOMContentLoaded",e):document.attachEvent("onreadystatechange",function(){"loading"!=document.readyState&&e()})},C.getJSON=function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.onreadystatechange=function(){if(4===this.readyState)if(this.status>=200&&this.status<400){var e=JSON.parse(this.responseText);t(e)}else console.error("Fetch failed!")},n.send(),n=null},HTMLElement.prototype.addClass=function(e){this.classList?this.classList.add(e):this.className+=" "+e},HTMLElement.prototype.removeClass=function(e){this.classList?this.classList.remove(e):this.className=this.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")},HTMLElement.prototype.empty=function(){for(;this.firstChild;)this.removeChild(this.firstChild);return this},HTMLElement.prototype.on=function(e,t){this.addEventListener?this.addEventListener(e,t):this.attachEvent("on"+e,function(){t.call(this)})},String.prototype.repeat=function(e){return 0>=e?"":this+this.repeat(e-1)},String.prototype.rjust=function(e,t){return t=(t||" ").substr(0,1),t.repeat(e-this.length)+this},Object.extend=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},_({calendar:"data/calendar.json",calendar_dates:"data/calendar_dates.json",stops:"data/stops.json",routes:"data/routes.json"},function(e){x=e,C.ready(g)})}();