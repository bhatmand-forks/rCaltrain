!function(){"use strict";function e(){var e=document.querySelectorAll.apply(document,arguments);return e.forEach=function(t){[].forEach.call(e,t)},e}function t(e){"loading"!=document.readyState?e():document.addEventListener?document.addEventListener("DOMContentLoaded",e):document.attachEvent("onreadystatechange",function(){"loading"!=document.readyState&&e()})}function n(e){return"undefined"!=typeof e&&null!==e}function r(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function o(e,t){return t<=0?"":e+o(e,t-1)}function a(e,t,n){return n=(n||" ").substr(0,1),o(n,t-e.length)+e}function i(e,t){var r=document.createElement(e);return n(t)&&Object.keys(t).forEach(function(e){r[e]=t[e]}),r}function c(e){for(;e.firstChild;)e.removeChild(e.firstChild);return e}function s(e,t){e.classList?e.classList.add(t):e.className+=" "+t}function u(e,t){e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")}function d(e,t,n){e.addEventListener?e.addEventListener(t,n):e.attachEvent("on"+t,function(){n.call(e)})}function f(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.onreadystatechange=function(){if(4===this.readyState)if(this.status>=200&&this.status<400){var e=JSON.parse(this.responseText);t(e)}else console.error("Fetch failed!")},n.send(),n=null}function l(){var e=";expires="+new Date(Date.now()+31536e6).toUTCString();document.cookie="from="+encodeURIComponent(D.getText())+e,document.cookie="to="+encodeURIComponent(L.getText())+e;var t=U(".when-button.selected"),r=n(t)?encodeURIComponent(U(".when-button.selected").getAttribute("value")):"";document.cookie="when="+r+e}function p(e){var t=new RegExp("(?:(?:^|.*;\\s*)"+e+"\\s*\\=\\s*([^;]*).*$)|^.*$");return decodeURIComponent(document.cookie.replace(t,"$1"))}function h(){var e=p("from"),t=p("to"),r=p("when");if(n(e)&&D.setText(e),n(t)&&L.setText(t),n(r)){var o=U('.when-button[value="'+r+'"]');n(o)&&s(o,"selected")}}function v(){var e=new Date;return 60*e.getHours()*60+60*e.getMinutes()+e.getSeconds()}function m(){var e=new Date;return parseInt([e.getFullYear(),e.getMonth()+1,e.getDate()].map(function(e){return a(e.toString(),2,"0")}).join(""))}function _(e){var t=Math.floor(e/60);return[Math.floor(t/60)%24,t%60].map(function(e){return a(e.toString(),2,"0")}).join(":")}function g(e,t){return Math.round((t-e)/60)}function y(){var e=U(".when-button.selected"),t=n(e)?encodeURIComponent(U(".when-button.selected").getAttribute("value")):"";return"now"===t}function w(e,t){var r=m(),o=U(".when-button.selected"),a=n(o)?encodeURIComponent(U(".when-button.selected").getAttribute("value")):"",i=a;if("now"===i)switch(((new Date).getDay()+6)%7){case 5:i="saturday";break;case 6:i="sunday";break;case 0:case 1:case 2:case 3:case 4:i="weekday";break;default:return console.error("Unknown current day",((new Date).getDay()+6)%7),[]}var c=Object.keys(e).filter(function(t){var n=e[t];return n.start_date<=r&&r<=n.end_date}).filter(function(t){return e[t][i]});return"now"===a&&(c=c.filter(function(e){return!(e in t)||0===t[e].filter(function(e){return e[0]===r&&2===e[1]}).length}).concat(Object.keys(t).filter(function(e){return 0!==t[e].filter(function(e){return e[0]===r&&1===e[1]}).length}))),0===c.length&&console.log("Can't get service for now."),c}function T(e,t,o){var a={};return w(t,o).forEach(function(t){Object.keys(e).forEach(function(o){var i=e[o],c=i[t];n(c)&&(n(a[o])||(a[o]={}),r(a[o],c))})}),a}function k(e,t){return t.map(function(t){return e.indexOf(t)}).filter(function(e){return e!=-1})}function x(e,t){return e.departure_time-t.departure_time}function C(e,t,r){var o=[];return Object.keys(e).forEach(function(a){var i=e[a];Object.keys(i).forEach(function(e){var a=i[e],c=a.map(function(e){return e[0]}),s=k(c,t),u=k(c,r);if(n(s)&&n(u)&&0!==s.length&&0!==u.length){var d=Math.min.apply(this,s),f=Math.max.apply(this,u);d>=f||(!y()||a[d][1]>v())&&o.push({departure_time:a[d][1],arrival_time:a[f][1]})}})}),o.sort(x)}function b(e){var t=c(U("#info"));if(y()&&n(e)){var r=g(v(),e.departure_time),o=i("div",{className:"info",textContent:"Next train: "+r+"min"});t.appendChild(o)}}function E(e){var t=c(U("#result"));e.forEach(function(e){var n=i("span",{className:"departure",textContent:_(e.departure_time)}),r=i("span",{className:"duration",textContent:g(e.departure_time,e.arrival_time)+" min"}),o=i("span",{className:"arrival",textContent:_(e.arrival_time)}),a=i("div",{className:"trip"});a.appendChild(n),a.appendChild(r),a.appendChild(o),t.appendChild(a)})}function j(){var e=R.stops,t=R.routes,r=R.calendar,o=R.calendar_dates,a=e[D.getText()],i=e[L.getText()],c=T(t,r,o);if(n(a)&&n(i)&&n(c)){var s=C(c,a,i);l(),b(s[0]),E(s)}}function S(){[D,L].forEach(function(e){e.on("focus",function(){e.setText(""),e.input.Show()}),e.on("change",j),e.on("complete",j)}),M.forEach(function(e){d(e,"click",function(){M.forEach(function(e){u(e,"selected")}),s(e,"selected"),j()})}),d(U("#reverse"),"click",function(){var e=D.getText();D.setText(L.getText()),L.setText(e),j()})}function O(){FastClick.attach(document.body),D=rComplete(U("#from"),{placeholder:"Departure"}),L=rComplete(U("#to"),{placeholder:"Destination"}),M=e(".when-button");var t=Object.keys(R.stops);D.setOptions(t),L.setOptions(t),h(),S(),j(),"?test=true"===window.location.search&&B()}function N(e,t){var n={};Object.keys(e).forEach(function(e){n[e]=void 0}),Object.keys(e).forEach(function(r){f(e[r],function(e){n[r]=e;for(var o in n)if("undefined"==typeof n[o])return;t(n)})})}function B(){!function(e,t,n,r){console.debug("Fetching test data"),N({weekday_NB_TT:"test/weekday_NB_TT.json",weekday_SB_TT:"test/weekday_SB_TT.json",weekend_NB_TT:"test/weekend_NB_TT.json",weekend_SB_TT:"test/weekend_SB_TT.json"},function(o){function c(e,t){if(!e){var n=i("div",{className:"test_result_item"});t.split("\n").forEach(function(e){n.appendChild(i("div",{textContent:e}))}),l.appendChild(n)}return e}function s(e){var t=e.split(":");return t[0]=t[0]%24,t.map(function(e){return a(e.toString(),2,"0")}).join(":")}function u(e){return"["+s(e[0])+"=>"+s(e[1])+"]"}function d(e){return"["+e[0]+"=>"+e[1]+"]"}function f(n,o){for(var a=n.length-1;a>=0;a--){var i=n[a].name,f=n[a].stop_times;if(c(t.getOptions().indexOf(i)>=0,"to_name is not in options:"+i)){t.setText(i);for(var l=a-1;l>=0;l--){var p=n[l].name,h=n[l].stop_times;if(c(e.getOptions().indexOf(p)>=0,"from_name is not in options:"+p)){e.setText(p);var v=[];if(c(h.length===f.length,"from_stops and to_stops have different length:"+p+"=>"+i))for(var m=h.length-1;m>=0;m--){var _=h[m],g=f[m];if(c(_.service_type===g.service_type,"from_stop and to_stop have different type: schedule:"+o+", "+p+"("+_.service_type+")=>"+i+"("+g.service_type+")["+_.time+"=>"+g.time+"]")){var y=_.service_type;if("SatOnly"===y&&"saturday"!==o)continue;_.time&&g.time&&v.unshift([_.time,g.time])}}v.sort(function(e,t){return e=e[0]+"=>"+e[1],t=t[0]+"=>"+t[1],e<t?-1:e>t?1:0});for(var w=[],T=r.children.length-1;T>=0;T--){var k=r.children[T];w.unshift([k.children[0].textContent,k.children[2].textContent])}if(c(v.length===w.length,"expects and actuals have different length:"+p+"=>"+i+"\nexpects:"+v.map(u).join(", ")+"\nactuals:"+w.map(d).join(", ")))for(var x=w.length-1;x>=0;x--){var C=s(v[x][0]),b=s(v[x][1]);c(w[x][0]===C&&w[x][1]===b,"time mismatch: schedule:"+o+", "+p+"=>"+i+", expected:("+C+" => "+b+"), actual:("+w[x][0]+" => "+w[x][1]+")")}}}}}}console.debug("Start testing");var l=i("div",{id:"test_result"});document.documentElement.appendChild(l),n[1].click(),f(o.weekday_NB_TT,"weekday"),f(o.weekday_SB_TT,"weekday"),n[2].click(),f(o.weekend_NB_TT,"saturday"),f(o.weekend_SB_TT,"saturday"),n[3].click(),f(o.weekend_NB_TT,"sunday"),f(o.weekend_SB_TT,"sunday");var p=i("div",{textContent:"Total failed:"+l.children.length});l.insertBefore(p,l.firstChild),console.debug("Finish testing")})}(D,L,M,U("#result"))}var D,L,M,R={},U=function(){return document.querySelector.apply(document,arguments)};N({calendar:"data/calendar.json",calendar_dates:"data/calendar_dates.json",stops:"data/stops.json",routes:"data/routes.json"},function(e){R=e,t(O)})}();