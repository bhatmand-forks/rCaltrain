!function(){"use strict";function e(e){return"undefined"!=typeof e}function t(){$.cookie("from",y.getText()),$.cookie("to",T.getText()),$.cookie("when",$(".when-button.selected").val())}function n(){$.cookie.defaults.expires=365,$.cookie.defaults.path="/",e($.cookie("from"))&&y.setText($.cookie("from")),e($.cookie("to"))&&T.setText($.cookie("to")),e($.cookie("when"))&&$('.when-button[value="'+$.cookie("when")+'"]').addClass("selected")}function r(){var e=new Date;return 60*e.getHours()*60+60*e.getMinutes()+e.getSeconds()}function o(){var e=new Date;return parseInt([e.getFullYear(),e.getMonth()+1,e.getDate()].map(function(e){return e.toString().rjust(2,"0")}).join(""))}function a(e){var t=Math.floor(e/60);return[Math.floor(t/60)%24,t%60].map(function(e){return e.toString().rjust(2,"0")}).join(":")}function i(e,t){return Math.round((t-e)/60)}function c(){return"now"===$(".when-button.selected").val()}function s(e,t){var n=o(),r=$(".when-button.selected").val(),a=r;if("now"===a)switch(((new Date).getDay()+6)%7){case 5:a="saturday";break;case 6:a="sunday";break;case 0:case 1:case 2:case 3:case 4:a="weekday";break;default:return console.error("Unknown current day",((new Date).getDay()+6)%7),[]}var i=Object.keys(e).filter(function(t){var r=e[t];return r.start_date<=n&&n<=r.end_date}).filter(function(t){return e[t][a]});return"now"===r&&(i=i.filter(function(e){return!(e in t)||0===t[e].filter(function(e){return e[0]===n&&2===e[1]}).length}).concat(Object.keys(t).filter(function(e){return 0!==t[e].filter(function(e){return e[0]===n&&1===e[1]}).length}))),0===i.length&&console.log("Can't get service for now."),i}function u(t,n,r){var o={};return s(n,r).forEach(function(n){Object.keys(t).forEach(function(r){var a=t[r],i=a[n];e(i)&&(e(o[r])||(o[r]={}),Object.extend(o[r],i))})}),o}function f(e,t){return t.map(function(t){return e.indexOf(t)}).filter(function(e){return-1!=e})}function d(e,t){return e.departure_time-t.departure_time}function l(t,n,o){var a=[];return Object.keys(t).forEach(function(i){var s=t[i];Object.keys(s).forEach(function(t){var i=s[t],u=i.map(function(e){return e[0]}),d=f(u,n),l=f(u,o);if(e(d)&&e(l)&&0!==d.length&&0!==l.length){var p=Math.min.apply(this,d),h=Math.max.apply(this,l);p>=h||(!c()||i[p][1]>r())&&a.push({departure_time:i[p][1],arrival_time:i[h][1]})}})}),a.sort(d)}function p(t){var n=$("#info").empty();if(c()&&e(t)){var o=i(r(),t.departure_time);n.append('<div class="info">Next train: '+o+"min</div>")}}function h(e){var t=$("#result").empty();e.forEach(function(e){t.append('<div class="trip"><span class="departure">'+a(e.departure_time)+'</span><span class="duration">'+i(e.departure_time,e.arrival_time)+' min</span><span class="arrival">'+a(e.arrival_time)+"</span></div>")})}function v(){var n=x.stops,r=x.routes,o=x.calendar,a=x.calendar_dates,i=n[y.getText()],c=n[T.getText()],s=u(r,o,a);if(e(i)&&e(c)&&e(s)){var f=l(s,i,c);t(),p(f[0]),h(f)}}function m(){[y,T].forEach(function(e){e.on("focus",function(){e.setText(""),e.input.Show()}),e.on("change",v),e.on("complete",v)}),w.each(function(e,t){$(t).on("click",function(){w.each(function(e,t){$(t).removeClass("selected")}),$(t).addClass("selected"),v()})}),$("#reverse").on("click",function(){var e=y.getText();y.setText(T.getText()),T.setText(e),v()})}function _(){FastClick.attach(document.body),y=rComplete($("#from")[0],{placeholder:"Departure"}),T=rComplete($("#to")[0],{placeholder:"Destination"}),w=$(".when-button");var e=Object.keys(x.stops);y.setOptions(e),T.setOptions(e),n(),m(),v(),"?test=true"===window.location.search&&k()}function g(e,t){var n={};Object.keys(e).forEach(function(e){n[e]=void 0}),Object.keys(e).forEach(function(r){$.getJSON(e[r],function(e){n[r]=e;for(var o in n)if("undefined"==typeof n[o])return;t(n)})})}function k(){!function(e,t,n,r){console.debug("Fetching test data"),g({weekday_NB_TT:"test/weekday_NB_TT.json",weekday_SB_TT:"test/weekday_SB_TT.json",weekend_NB_TT:"test/weekend_NB_TT.json",weekend_SB_TT:"test/weekend_SB_TT.json"},function(o){function a(e,t){if(!e){var n=document.createElement("div");n.className="test_result_item",t.split("\n").forEach(function(e){var t=document.createElement("div");t.textContent=e,n.appendChild(t)}),f.appendChild(n)}return e}function i(e){var t=e.split(":");return t[0]=t[0]%24,t.map(function(e){return e.toString().rjust(2,"0")}).join(":")}function c(e){return"["+i(e[0])+"=>"+i(e[1])+"]"}function s(e){return"["+e[0]+"=>"+e[1]+"]"}function u(n,o){for(var u=n.length-1;u>=0;u--){var f=n[u].name,d=n[u].stop_times;if(a(t.getOptions().indexOf(f)>=0,"to_name is not in options:"+f)){t.setText(f);for(var l=u-1;l>=0;l--){var p=n[l].name,h=n[l].stop_times;if(a(e.getOptions().indexOf(p)>=0,"from_name is not in options:"+p)){e.setText(p);var v=[];if(a(h.length===d.length,"from_stops and to_stops have different length:"+p+"=>"+f))for(var m=h.length-1;m>=0;m--){var _=h[m],g=d[m];if(a(_.service_type===g.service_type,"from_stop and to_stop have different type: schedule:"+o+", "+p+"("+_.service_type+")=>"+f+"("+g.service_type+")["+_.time+"=>"+g.time+"]")){var k=_.service_type;if("SatOnly"===k&&"saturday"!==o)continue;_.time&&g.time&&v.unshift([_.time,g.time])}}v.sort(function(e,t){return e=e[0]+"=>"+e[1],t=t[0]+"=>"+t[1],t>e?-1:e>t?1:0});for(var y=[],T=r.children.length-1;T>=0;T--){var w=r.children[T];y.unshift([w.children[0].textContent,w.children[2].textContent])}if(a(v.length===y.length,"expects and actuals have different length:"+p+"=>"+f+"\nexpects:"+v.map(c).join(", ")+"\nactuals:"+y.map(s).join(", ")))for(var x=y.length-1;x>=0;x--){var j=i(v[x][0]),$=i(v[x][1]);a(y[x][0]===j&&y[x][1]===$,"time mismatch: schedule:"+o+", "+p+"=>"+f+", expected:("+j+" => "+$+"), actual:("+y[x][0]+" => "+y[x][1]+")")}}}}}}console.debug("Start testing");var f=document.createElement("div");f.id="test_result",document.documentElement.appendChild(f),n[1].click(),u(o.weekday_NB_TT,"weekday"),u(o.weekday_SB_TT,"weekday"),n[2].click(),u(o.weekend_NB_TT,"saturday"),u(o.weekend_SB_TT,"saturday"),n[3].click(),u(o.weekend_NB_TT,"sunday"),u(o.weekend_SB_TT,"sunday");var d=document.createElement("div");d.textContent="Total failed:"+f.children.length,f.insertBefore(d,f.firstChild),console.debug("Finish testing")})}(y,T,w,document.querySelector("#result"))}var y,T,w,x={};String.prototype.repeat=function(e){return 0>=e?"":this+this.repeat(e-1)},String.prototype.rjust=function(e,t){return t=(t||" ").substr(0,1),t.repeat(e-this.length)+this},Object.extend=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},g({calendar:"data/calendar.json",calendar_dates:"data/calendar_dates.json",stops:"data/stops.json",routes:"data/routes.json"},function(e){x=e,$(_)})}();