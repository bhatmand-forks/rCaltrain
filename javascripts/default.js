!function(){"use strict";function e(e){return"undefined"!=typeof e}function t(){$.cookie("from",g.getText()),$.cookie("to",k.getText()),$.cookie("when",$(".when-button.selected").val())}function n(){$.cookie.defaults.expires=365,$.cookie.defaults.path="/",e($.cookie("from"))&&g.setText($.cookie("from")),e($.cookie("to"))&&k.setText($.cookie("to")),e($.cookie("when"))&&$('.when-button[value="'+$.cookie("when")+'"]').addClass("selected")}function r(e){var t=e.split(":").map(function(e){return parseInt(e)}),n=new Date;return n.setHours(t[0],t[1],t[2]),n}function i(e){return[e.getHours().toString().rjust(2,"0"),e.getMinutes().toString().rjust(2,"0")].join(":")}function o(e,t){return Math.round((t-e)/1e3/60)}function a(){return"now"===$(".when-button.selected").val()}function s(){if(a()){var t=new Date;switch(t.getDay()){case 1:case 2:case 3:case 4:case 5:return/Weekday/i;case 6:return/Saturday/i;case 0:return/Sunday/i;default:return void alert("now_date.getDay() got wrong: "+t.getDay())}}else{var n=$(".when-button.selected").val();if(e(n))return n=n.charAt(0).toUpperCase()+n.substring(1),new RegExp(n,"i")}}function u(e,t){return e.departure_time-t.departure_time}function c(t,n){return t.map(function(e){return n[e]}).filter(function(t){return e(t)})[0]}function f(t,n,r,i){return Object.keys(t).filter(function(e){return i.test(e)}).map(function(i){var o=t[i],s=c(n,o),u=c(r,o);return e(s)&&e(u)&&s.stop_sequence<u.stop_sequence&&(!a()||s.departure_time>new Date)?{departure_time:s.departure_time,arrival_time:u.arrival_time}:void 0}).filter(function(t){return e(t)}).sort(u)}function p(t){var n=$("#info").empty();if(a()&&e(t)){var r=o(new Date,t.departure_time);n.append('<div class="info">Next train: '+r+"min</div>")}}function l(e){var t=$("#result").empty();e.forEach(function(e){var n=i(e.departure_time),r=i(e.arrival_time),a=o(e.departure_time,e.arrival_time);t.append('<div class="trip"><span class="departure">'+n+'</span><span class="duration">'+a+' min</span><span class="arrival">'+r+"</span></div>")})}function d(){var n=_.cities,r=_.services,i=n[g.getText()],o=n[k.getText()],a=s();if(e(i)&&e(o)&&e(a)){var u=f(r,i,o,a);t(),p(u[0]),l(u)}}function v(){[g,k].forEach(function(e){e.on("focus",function(){e.setText(""),e.input.Show()}),e.on("change",d),e.on("complete",d)}),w.each(function(e,t){$(t).on("click",function(){w.each(function(e,t){$(t).removeClass("selected")}),$(t).addClass("selected"),d()})}),$("#reverse").on("click",function(){var e=g.getText();g.setText(k.getText()),k.setText(e),d()})}function m(){FastClick.attach(document.body),g=rComplete($("#from")[0],{placeholder:"Departure"}),k=rComplete($("#to")[0],{placeholder:"Destination"}),w=$(".when-button");var e=_.stops,t=_.times,i=Object.keys(e);g.setOptions(i),k.setOptions(i),Object.keys(t).forEach(function(e){Object.keys(t[e]).forEach(function(n){var i=t[e][n];t[e][n]={departure_time:r(i[0]),arrival_time:r(i[1]),stop_sequence:parseInt(i[2])}})}),_={cities:e,services:t},v(),n(),d()}function h(e,t){var n={},t=t;return e.forEach(function(e){n[e]=!1}),function(e){n[e]=!0;var r=!0;for(var i in n)if(!n[i]){r=!1;break}r&&t()}}var g,k,w,_={};String.prototype.repeat=function(e){for(var t=0,n="";e>t;t++)n+=this;return n},String.prototype.rjust=function(e,t){return t=t||" ",t=t.substr(0,1),this.length<e?t.repeat(e-this.length)+this:this};var y=h(["stops","times"],function(){$(m)});$.getJSON("data/stops.json",function(e){_.stops=e,y("stops")}),$.getJSON("data/times.json",function(e){_.times=e,y("times")})}();