!function(){"use strict";function t(t){return"undefined"!=typeof t}function e(){$.cookie("from",m.getText()),$.cookie("to",g.getText()),$.cookie("when",$(".when-button.selected").val())}function n(){$.cookie.defaults.expires=365,$.cookie.defaults.path="/",t($.cookie("from"))&&m.setText($.cookie("from")),t($.cookie("to"))&&g.setText($.cookie("to")),t($.cookie("when"))&&$('.when-button[value="'+$.cookie("when")+'"]').addClass("selected")}function r(){var t=new Date;return 60*t.getHours()*60+60*t.getMinutes()+t.getSeconds()}function o(t){var e=Math.floor(t/60);return[Math.floor(e/60),e%60].map(function(t){return t.toString().rjust(2,"0")}).join(":")}function i(t,e){return Math.round((e-t)/60)}function a(){return"now"===$(".when-button.selected").val()}function s(){if(a()){var e=new Date;switch(e.getDay()){case 1:case 2:case 3:case 4:case 5:return/Weekday/i;case 6:return/Saturday/i;case 0:return/Sunday/i;default:return void alert("now_date.getDay() got wrong: "+e.getDay())}}else{var n=$(".when-button.selected").val();if(t(n))return n=n.charAt(0).toUpperCase()+n.substring(1),new RegExp(n,"i")}}function c(t,e){return t.departure_time-e.departure_time}function u(e,n,o,i){return Object.keys(e).filter(function(t){return i.test(t)}).map(function(i){var s=e[i],c=0,u=s.length,f=[n,o].map(function(e){for(;u>c;){var n=s[c][0],r=e.filter(function(t){return t==n})[0];if(t(r))return s[c][1];++c}});return t(f[0])&&t(f[1])&&(!a()||f[0]>r())?{departure_time:f[0],arrival_time:f[1]}:void 0}).filter(function(e){return t(e)}).sort(c)}function f(e){var n=$("#info").empty();if(a()&&t(e)){var o=i(r(),e.departure_time);n.append('<div class="info">Next train: '+o+"min</div>")}}function p(t){var e=$("#result").empty();t.forEach(function(t){e.append('<div class="trip"><span class="departure">'+o(t.departure_time)+'</span><span class="duration">'+i(t.departure_time,t.arrival_time)+' min</span><span class="arrival">'+o(t.arrival_time)+"</span></div>")})}function l(){var n=w.cities,r=w.services,o=n[m.getText()],i=n[g.getText()],a=s();if(t(o)&&t(i)&&t(a)){var c=u(r,o,i,a);e(),f(c[0]),p(c)}}function d(){[m,g].forEach(function(t){t.on("focus",function(){t.setText(""),t.input.Show()}),t.on("change",l),t.on("complete",l)}),k.each(function(t,e){$(e).on("click",function(){k.each(function(t,e){$(e).removeClass("selected")}),$(e).addClass("selected"),l()})}),$("#reverse").on("click",function(){var t=m.getText();m.setText(g.getText()),g.setText(t),l()})}function v(){FastClick.attach(document.body),m=rComplete($("#from")[0],{placeholder:"Departure"}),g=rComplete($("#to")[0],{placeholder:"Destination"}),k=$(".when-button");var t=Object.keys(w.stops);m.setOptions(t),g.setOptions(t),w={cities:w.stops,services:w.times},d(),n(),l()}function h(t,e){var n={},e=e;return t.forEach(function(t){n[t]=!1}),function(t){n[t]=!0;var r=!0;for(var o in n)if(!n[o]){r=!1;break}r&&e()}}var m,g,k,w={};String.prototype.repeat=function(t){for(var e=0,n="";t>e;e++)n+=this;return n},String.prototype.rjust=function(t,e){return e=e||" ",e=e.substr(0,1),this.length<t?e.repeat(t-this.length)+this:this};var x=h(["stops","times"],function(){$(v)});$.getJSON("data/stops.json",function(t){w.stops=t,x("stops")}),$.getJSON("data/times.json",function(t){w.times=t,x("times")})}();