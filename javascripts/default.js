function is_defined(e){return"undefined"!=typeof e}function save_cookies(){$.cookie("from",from.getText()),$.cookie("to",to.getText()),$.cookie("when",$("input[name=when]:checked").val())}function load_cookies(){if($.cookie.defaults.expires=365,$.cookie.defaults.path="/",is_defined($.cookie("from"))&&from.setText($.cookie("from")),is_defined($.cookie("to"))&&to.setText($.cookie("to")),is_defined($.cookie("when"))){var e=$("input[name=when][value="+$.cookie("when")+"]");e.parent().click()}}function str2date(e){var t=e.split(":").map(function(e){return parseInt(e)}),i=new Date;return i.setHours(t[0],t[1],t[2]),i}function date2str(e){return[e.getHours().toString().rjust(2,"0"),e.getMinutes().toString().rjust(2,"0")].join(":")}function time_relative(e,t){return Math.round((t-e)/1e3/60)}function is_now(){return"now"===$("input[name=when]:checked").val()}function get_trip_match_regexp(){if(is_now()){var e=new Date;switch(e.getDay()){case 1:case 2:case 3:case 4:case 5:return/Weekday/i;case 6:return/Saturday/i;case 0:return/Sunday/i;default:return void alert("now_date.getDay() got wrong: "+e.getDay())}}else{var t=$("input[name=when]:checked").val();if(is_defined(t))return t=t.charAt(0).toUpperCase()+t.substring(1),new RegExp(t,"i")}}function compare_trip(e,t){return e.departure_time-t.departure_time}function get_trips(e,t,i){var n=[],r=get_trip_match_regexp();if(is_defined(r)){for(var a in e)if(r.exec(a)){var o=e[a],s=void 0,c=void 0;t.forEach(function(e){is_defined(o[e])&&(s=o[e])}),i.forEach(function(e){is_defined(o[e])&&(c=o[e])}),is_defined(s)&&is_defined(c)&&s.stop_sequence<c.stop_sequence&&(!is_now()||s.departure_time>new Date)&&n.push({departure_time:s.departure_time,arrival_time:c.arrival_time})}return n.sort(compare_trip)}}function render_info(e){var t=$("#info").empty();if(is_now()&&is_defined(e)){var i=time_relative(new Date,e.departure_time);t.append('<div class="info">Next train: '+i+"min</div>")}}function render_result(e){var t=$("#result").empty();e.forEach(function(e){var i=date2str(e.departure_time),n=date2str(e.arrival_time),r=time_relative(e.departure_time,e.arrival_time);t.append('<div class="trip">'+i+" => "+n+" ("+r+"min)</div>")})}function schedule(e){var t=e.data.cities,i=e.data.services,n=t[from.getText()],r=t[to.getText()],a=get_trips(i,n,r);is_defined(n)&&is_defined(r)&&is_defined(a)&&(save_cookies(),render_info(a[0]),render_result(a))}function bind_events(e){var t={data:e};[from,to].forEach(function(e){var i=$('<span class="cancel">x</span>').on("click",function(){e.setText(""),e.input.focus()}),n=function(){""===e.input.value?i.hide():i.show(),schedule(t)};e.on("change",n),e.on("complete",n),$(e.wrapper).append(i)}),when.each(function(t,i){$(i).on("click",e,function(e){when.each(function(e,t){$(t).removeClass("selected")}),$(i).addClass("selected"),schedule(e)})}),$("#reverse").on("click",e,function(e){var t=from.getText();from.setText(to.getText()),to.setText(t),schedule(e)})}function initialize(e){var t=e.stops,i=e.times,n={};t.forEach(function(e){var t=e.stop_id,i=e.stop_name;is_defined(n[i])?n[i].push(t):n[i]=[t]});var r=Object.keys(n);from.setOptions(r),to.setOptions(r);var a={};i.forEach(function(e){var t=e.trip_id;is_defined(a[t])||(a[t]={}),a[t][e.stop_id]={departure_time:str2date(e.departure_time),arrival_time:str2date(e.arrival_time),stop_sequence:e.stop_sequence}});var e={cities:n,services:a};bind_events(e),load_cookies(),schedule({data:e})}function data_checker(e,t){var i={},n={},t=t;return e.forEach(function(e){i[e]=!1}),function(e,r){i[e]=!0,n[e]=r;var a=!0;for(var o in i)i[o]||(a=!1);a&&t(n)}}var from,to,when;String.prototype.repeat=function(e){for(var t=0,i="";e>t;t++)i+=this;return i},String.prototype.rjust=function(e,t){return t=t||" ",t=t.substr(0,1),this.length<e?t.repeat(e-this.length)+this:this},$(function(){FastClick.attach(document.body)}),$(document).ready(function(){var e=data_checker(["stops","times"],initialize);from=rComplete($("#from")[0],{placeholder:"Departure"}),to=rComplete($("#to")[0],{placeholder:"Destination"}),when=$(".when-label"),Papa.parse("data/stops.csv",{download:!0,dynamicTyping:!0,header:!0,complete:function(t){e("stops",t.data)}}),Papa.parse("data/times.csv",{download:!0,dynamicTyping:!0,header:!0,complete:function(t){e("times",t.data)}})});