!function(){"use strict";function t(t){return"undefined"!=typeof t}function e(){$.cookie("from",y.getText()),$.cookie("to",w.getText()),$.cookie("when",$(".when-button.selected").val())}function n(){$.cookie.defaults.expires=365,$.cookie.defaults.path="/",t($.cookie("from"))&&y.setText($.cookie("from")),t($.cookie("to"))&&w.setText($.cookie("to")),t($.cookie("when"))&&$('.when-button[value="'+$.cookie("when")+'"]').addClass("selected")}function r(){var t=new Date;return 60*t.getHours()*60+60*t.getMinutes()+t.getSeconds()}function o(){var t=new Date;return parseInt([t.getFullYear(),t.getMonth()+1,t.getDate()].map(function(t){return t.toString().rjust(2,"0")}).join(""))}function a(t){var e=Math.floor(t/60);return[Math.floor(e/60),e%60].map(function(t){return t.toString().rjust(2,"0")}).join(":")}function i(t,e){return Math.round((e-t)/60)}function u(){return"now"===$(".when-button.selected").val()}function c(t,e){var n=o(),r=$(".when-button.selected").val(),a="now"===r?((new Date).getDay()+6)%7:"weekday"===r?1:"saturday"===r?5:"sunday"===r?6:-1;if(-1===a)return[];var i=Object.keys(t).filter(function(e){var r=t[e];return r[7]<=n&&n<=r[8]}).filter(function(e){return 1===t[e][a]});return"now"===r&&(i=i.filter(function(t){return!(t in e)||0===e[t].filter(function(t){return t[0]===n&&2===t[1]}).length}).concat(Object.keys(e).filter(function(t){return 0!==e[t].filter(function(t){return t[0]===n&&1===t[1]}).length}))),0===i.length&&console.log("Can't get service for now."),i}function f(e,n,r){var o={};return c(n,r).forEach(function(n){Object.keys(e).forEach(function(r){var a=e[r],i=a[n];t(i)&&(t(o[r])||(o[r]={}),Object.extend(o[r],i))})}),o}function s(t,e){return e.map(function(e){return t.indexOf(e)}).filter(function(t){return-1!=t})}function l(t,e){return t.departure_time-e.departure_time}function p(e,n,o){var a=[];return Object.keys(e).forEach(function(i){var c=e[i];Object.keys(c).forEach(function(e){var i=c[e],f=i.map(function(t){return t[0]}),l=s(f,n),p=s(f,o);if(t(l)&&t(p)&&0!==l.length&&0!==p.length){var d=Math.min.apply(this,l),h=Math.max.apply(this,p);d>=h||(!u()||i[d][1]>r())&&a.push({departure_time:i[d][1],arrival_time:i[h][1]})}})}),a.sort(l)}function d(e){var n=$("#info").empty();if(u()&&t(e)){var o=i(r(),e.departure_time);n.append('<div class="info">Next train: '+o+"min</div>")}}function h(t){var e=$("#result").empty();t.forEach(function(t){e.append('<div class="trip"><span class="departure">'+a(t.departure_time)+'</span><span class="duration">'+i(t.departure_time,t.arrival_time)+' min</span><span class="arrival">'+a(t.arrival_time)+"</span></div>")})}function v(){var n=b.stops,r=b.routes,o=b.calendar,a=b.calendar_dates,i=n[y.getText()],u=n[w.getText()],c=f(r,o,a);if(t(i)&&t(u)&&t(c)){var s=p(c,i,u);e(),d(s[0]),h(s)}}function m(){[y,w].forEach(function(t){t.on("focus",function(){t.setText(""),t.input.Show()}),t.on("change",v),t.on("complete",v)}),x.each(function(t,e){$(e).on("click",function(){x.each(function(t,e){$(e).removeClass("selected")}),$(e).addClass("selected"),v()})}),$("#reverse").on("click",function(){var t=y.getText();y.setText(w.getText()),w.setText(t),v()})}function g(){FastClick.attach(document.body),y=rComplete($("#from")[0],{placeholder:"Departure"}),w=rComplete($("#to")[0],{placeholder:"Destination"}),x=$(".when-button");var t=Object.keys(b.stops);y.setOptions(t),w.setOptions(t),n(),m(),v()}function k(t,e){var n={};return t.forEach(function(t){n[t]=!1}),function(t){n[t]=!0;var r=!0;for(var o in n)if(!n[o]){r=!1;break}r&&e()}}var y,w,x,b={};String.prototype.repeat=function(t){return 0>=t?"":this+this.repeat(t-1)},String.prototype.rjust=function(t,e){return e=(e||" ").substr(0,1),e.repeat(t-this.length)+this},Object.extend=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t};var j=["calendar","calendar_dates","stops","routes"],O=k(j,function(){$(g)});j.forEach(function(t){$.getJSON("data/"+t+".json",function(e){b[t]=e,O(t)})})}();